# Thai Legal RAG System

โปรเจกต์นี้เป็นการพัฒนาระบบ Retrieval-Augmented Generation (RAG) ที่ออกแบบมาเพื่อการตอบคำถามข้อกฎหมายไทยโดยเฉพาะ โดยมุ่งเน้นความแม่นยำทางข้อเท็จจริง (Factual Accuracy) การตีความเชิงตรรกะแบบกฎหมาย (Legal Logic) และการลดอาการคิดไปเองของโมเดล (Hallucination)

---

## สถาปัตยกรรมระบบ (System Architecture)

สถาปัตยกรรมของระบบถูกแบบออกเป็น 4 ส่วนหลัก ดังนี้:

### 1. Data Ingestion (การนำเข้าข้อมูล)
กระบวนการย่อยข้อมูลกฎหมายถูกออกแบบมาเพื่อรักษาโครงสร้างของกฎหมายไทยอย่างเคร่งครัด
*   **Hybrid Chunking Strategy:** ใช้ Regular Expressions (RegEx) เพื่อหา "หัวมาตรา" (มาตรา/ข้อ) และแยกเนื้อหากฎหมายออกเป็นกลุ่มตามมาตราก่อน จากนั้นจึงใช้ `RecursiveCharacterTextSplitter` เพื่อซอยเนื้อหาที่ยาวเกินไปตามจังหวะขึ้นบรรทัดใหม่ เพื่อไม่ให้ประโยคขาดตอน
*   **Hierarchical Metadata:** สกัดข้อมูลสำคัญ เช่น `title` (ชื่อกฎหมาย), `section_id` (เลขมาตราแบบข้อความ), `hierarchy_level` (ลำดับศักดิ์ของกฎหมาย) และฝังไว้ในทุก Chunk เพื่อให้ AI ตระหนักถึงความสำคัญของกฎหมายแต่ละระดับ
*   **Prefix Context Injection:** นำ Metadata อย่างชื่อกฎหมายและเลขมาตรา ไปแปะไว้ส่วนหัวของทุก Chunk เพื่อเป็นเข็มทิศให้ AI เสมอ

### 2. Hybrid Retrieval (การดึงข้อมูล)
ผสานเทคนิคการค้นหาสองรูปแบบเข้าด้วยกันเพื่อความแม่นยำสูงสุด
*   **Vector Search (Semantic):** ดึงข้อมูล Candidate เบื้องต้นด้วย `HuggingFaceEmbeddings` ผ่าน `ChromaDB` (ดึงจำนวนมาก เช่น k=300 เพื่อกวาดมาตราที่เกี่ยวข้องให้ครบ)
*   **Keyword Search (BM25 with PyThaiNLP):** ทำการ Re-ranking โฟกัสคำเฉพาะเจาะจง (เช่น เลขมาตราเป๊ะๆ) โดยใช้ `pythainlp.tokenize.word_tokenize` เป็นตัวตัดคำ
*   **Reciprocal Rank Fusion (RRF):** นำผลลัพธ์จาก Vector และ BM25 มารวมคะแนนและจัดอันดับความน่าจะเป็นใหม่
*   **Hard Metadata Filtering:** ดักจับ Keyword ชื่อกฎหมายจากคำถามของผู้ใช้ (เช่น "พระราชบัญญัติธุรกิจสถาบันการเงิน") เพื่อเจาะจงค้นหาเฉพาะในเอกสารของกฎหมายฉบับนั้น ป้องกันปัญหาดึงกฎหมายเรื่องอื่นมาตอบปะปน

### 3. Generation (การสร้างคำตอบ)
ใช้ Local LLM เป็นเครื่องยนต์หลักในการสรุปและตอบคำถาม
*   **Temperature Control:** กำหนดค่า `temperature=0.0` เพื่อลดความเป็นไปได้ในการแต่งเรื่องเอง
*   **Chain-of-Thought (CoT) Prompting:** บังคับให้ LLM "ยกข้อเท็จจริงอ้างอิง" จากเนื้อหาขึ้นมาก่อนที่จะทำการ "สรุป" เพื่อจัดระเบียบตรรกะในหัวของโมเดลเสียก่อน ช่วยแก้ปัญหาความสับสนเรื่องรูปประโยคปฏิเสธ (เช่น คำว่า "มิให้")
*   **Strict Polarity Rules:** สั่งให้ LLM ฟันธงตอบในรูปแบบที่ชัดเจน (เช่น ใช่/ไม่ใช่, ได้/ไม่ได้) โดยไม่อนุญาตให้ตอบแบบกำกวม

### 4. Evaluation (การประเมินผล)
ระบบประเมินความแม่นยำด้วยเทคนิค LLM-as-a-Judge
*   **Context-Aware Judging:** ประเมินเปรียบเทียบคำตอบของ AI (AI Prediction) กับความจริง (Ground Truth)
*   **Synonym Resilience:** ควบคุม Judge Prompt ให้ความยืดหยุ่นกับคำพ้องความหมายภาษาไทย (เช่น "ไม่ได้" ให้ถือว่ามีความหมายตรงกับ "ไม่สามารถทำได้") เพื่อลดปัญหา False Negative จากการตรวจให้คะแนน

---

## เทคโนโลยีที่ใช้งาน (Tech Stack)

*   **LangChain:** เฟรมเวิร์กหลักสำหรับสร้าง AI Agents, Data Loaders, Prompts, Output Parsers และประกอบรวมกันเป็น Chain
*   **ChromaDB:** ฐานข้อมูล Vector Database แบบ Offline (Local)
*   **Ollama:** เครื่องมือสำหรับรัน Local LLM (เช่น Llama 3.2 3B) รองรับการโต้ตอบที่รวดเร็ว
*   **HuggingFace Embeddings:** โมเดลจำลองความหมายข้อความ (เช่น BAAI/bge-m3)
*   **PyThaiNLP:** ไลบรารีประมวลผลภาษาไทย ใช้เป็นตัวสับฟังก์ชันในอัลกอริทึม BM25 เพื่อการสืบค้นที่แม่นยำ

---

## ตัวอย่างข้อมูล (Example Data Format)

ตัวอย่างชุดข้อมูลข้อสอบประเมินระบบ RAG กฎหมาย:

```json
{
  "question": "นิติบุคคลใช้คำว่า บริษัทเครดิตฟองซิเอร์ นำหน้าชื่อบริษัท ก่อนได้รับใบอนุญาตสามารถนำมาใช้ได้หรือไม่",
  "positive_contexts": [
    "สถาบันการเงินต้องใช้ชื่อซึ่งมีคำว่า “ธนาคาร” “บริษัทเงินทุน” หรือ “บริษัทเครดิตฟองซิเอร์” นำหน้า ตามที่ระบุในใบอนุญาต แล้วแต่กรณี"
  ],
  "positive_answer": "ไม่ได้ เนื่องจากยังไม่ได้รับใบอนุญาตที่ระบุชื่อของกิจการ"
}
```

---

## แหล่งข้อมูล (References & Datasets)

อ้างอิงชุดข้อมูลกฎหมายไทยจากการเผยแพร่โดย Open Law Data Thailand:

1.  **ocs-krisdika:** ชุดข้อมูลกฎหมายจากสำนักงานคณะกรรมการกฤษฎีกา
2.  **iapp_2025:** ชุดข้อมูลกฎหมายประกาศใหม่ประมวลผลผ่าน OCR
3.  **WangchanX-Legal-ThaiCCL-RAG:** ชุดข้อมูลสำหรับการประเมินระบบ RAG กฎหมายไทยโดยศูนย์วิจัย AIResearch
